<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>3&nbsp; Smoothing, Detrending, and Deseasonalizing – Time Series Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./l04_arma.html" rel="next">
<link href="./l02_tsintro.html" rel="prev">
<link href="./tsar_fav.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-70a47bd5681a7291082a5b9f83d58762.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./l03_smoothing.html"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Smoothing, Detrending, and Deseasonalizing</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Time Series Analysis</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/vlyubchich/tsar/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l01_regression.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Review of Linear Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l02_tsintro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to Time Series Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l03_smoothing.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Smoothing, Detrending, and Deseasonalizing</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l04_arma.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Autoregressive Moving Average (ARMA) Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l05_arima.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Autoregressive Integrated Moving Average (ARIMA) Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l06_garch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Generalized Autoregressive Conditional Heteroskedasticity (GARCH) Models</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l07_trendtest.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Trend Detection</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l08_tsreg1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Time Series Regression with Trends</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l09_tsreg2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Time Series Regression with Correlated Errors</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l12_forecast.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Model Evaluation and Forecasting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./l13_spectral.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Spectral Analysis</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./software.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Software</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s1_wls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Weighted least squares</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s2_gls.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Generalized least squares</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s4_trendsync.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Synchrony of parametric trends</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s7_garma.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">D</span>&nbsp; <span class="chapter-title">Generalized autoregressive moving average (GARMA) models</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./s_practice.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">E</span>&nbsp; <span class="chapter-title">Practice exercises</span></span></a>
  </div>
</li>
      </ul>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction"><span class="header-section-number">3.1</span> Introduction</a></li>
  <li>
<a href="#sec-movavg" id="toc-sec-movavg" class="nav-link" data-scroll-target="#sec-movavg"><span class="header-section-number">3.2</span> Finite moving average smoothing</a>
  <ul class="collapse">
<li><a href="#sec-movavgSeas" id="toc-sec-movavgSeas" class="nav-link" data-scroll-target="#sec-movavgSeas"><span class="header-section-number">3.2.1</span> Moving average smoothing for seasonal data</a></li>
  </ul>
</li>
  <li>
<a href="#sec-lowess" id="toc-sec-lowess" class="nav-link" data-scroll-target="#sec-lowess"><span class="header-section-number">3.3</span> Lowess smoothing</a>
  <ul class="collapse">
<li><a href="#lowess-smoothing-for-seasonal-data" id="toc-lowess-smoothing-for-seasonal-data" class="nav-link" data-scroll-target="#lowess-smoothing-for-seasonal-data"><span class="header-section-number">3.3.1</span> Lowess smoothing for seasonal data</a></li>
  </ul>
</li>
  <li>
<a href="#exponential-smoothing" id="toc-exponential-smoothing" class="nav-link" data-scroll-target="#exponential-smoothing"><span class="header-section-number">3.4</span> Exponential smoothing</a>
  <ul class="collapse">
<li><a href="#exponential-smoothing-for-seasonal-data" id="toc-exponential-smoothing-for-seasonal-data" class="nav-link" data-scroll-target="#exponential-smoothing-for-seasonal-data"><span class="header-section-number">3.4.1</span> Exponential smoothing for seasonal data</a></li>
  </ul>
</li>
  <li>
<a href="#sec-regressionTime" id="toc-sec-regressionTime" class="nav-link" data-scroll-target="#sec-regressionTime"><span class="header-section-number">3.5</span> Polynomial regression on time</a>
  <ul class="collapse">
<li><a href="#seasonal-regression-with-dummy-variables" id="toc-seasonal-regression-with-dummy-variables" class="nav-link" data-scroll-target="#seasonal-regression-with-dummy-variables"><span class="header-section-number">3.5.1</span> Seasonal regression with dummy variables</a></li>
  <li><a href="#seasonal-regression-with-fourier-series" id="toc-seasonal-regression-with-fourier-series" class="nav-link" data-scroll-target="#seasonal-regression-with-fourier-series"><span class="header-section-number">3.5.2</span> Seasonal regression with Fourier series</a></li>
  </ul>
</li>
  <li><a href="#sec-GAM" id="toc-sec-GAM" class="nav-link" data-scroll-target="#sec-GAM"><span class="header-section-number">3.6</span> Generalized additive models (GAMs)</a></li>
  <li><a href="#sec-differencing" id="toc-sec-differencing" class="nav-link" data-scroll-target="#sec-differencing"><span class="header-section-number">3.7</span> Differencing</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">3.8</span> Conclusion</a></li>
  <li><a href="#appendix" id="toc-appendix" class="nav-link" data-scroll-target="#appendix"><span class="header-section-number">3.9</span> Appendix</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/vlyubchich/tsar/edit/master/l03_smoothing.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/vlyubchich/tsar/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Smoothing, Detrending, and Deseasonalizing</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><p>The goal of this lecture is to learn a variety of methods used for <em>trend visualization</em> (such that make a trend in noisy data more apparent), <em>trend modeling</em> (such that can help us to come up with ‘an equation’ for the trend, which could be further studied or used for interpolation, forecasting, or detrending), and <em>detrending</em> (just to remove trend from the series, with or without modeling it). You should be able to choose a method based on the goals of your analysis. We will start with simple and widely used methods that can be further combined into more elaborate algorithms.</p>
<p><strong>Objectives</strong></p>
<ol type="1">
<li>Implement smoothing methods often used for trend
<ul>
<li>visualization (example: moving average, lowess);</li>
<li>modeling (example: exponential smoothing, polynomial smoothing);</li>
<li>removal (example: differencing, however, the above methods also can be used to remove trends).</li>
</ul>
</li>
<li>Accomplish each of the tasks above when handling a time series with cycles (seasonality).</li>
<li>Understand the concepts of trend- and difference-stationary time series.</li>
</ol>
<p><strong>Reading materials</strong></p>
<ul>
<li>Chapter 1.5 in <span class="citation" data-cites="Brockwell:Davis:2002">Brockwell and Davis (<a href="references.html#ref-Brockwell:Davis:2002" role="doc-biblioref">2002</a>)</span>
</li>
<li>Chapter 5 in <span class="citation" data-cites="Kirchgassner:Wolters:2007">Kirchgässner and Wolters (<a href="references.html#ref-Kirchgassner:Wolters:2007" role="doc-biblioref">2007</a>)</span> (optional)</li>
</ul>
<section id="introduction" class="level2" data-number="3.1"><h2 data-number="3.1" class="anchored" data-anchor-id="introduction">
<span class="header-section-number">3.1</span> Introduction</h2>
<p>Recall the classical decomposition <span id="eq-trseas"><span class="math display">\[
Y_t = M_t + S_t + \epsilon_t,
\tag{3.1}\]</span></span> where <span class="math inline">\(M_t\)</span> is a slowly changing function (trend component), <span class="math inline">\(\epsilon_t\)</span> is stationary random noise component, and <span class="math inline">\(S_t\)</span> is the periodic term with the period <span class="math inline">\(m\geqslant 2\)</span> (seasonal component) and scaling factors <span class="math inline">\(\lambda_k &gt; 0\)</span> such that <span class="math inline">\(S_{t+km} = \lambda_kS_t\)</span> for <span class="math inline">\(1 \leqslant t \leqslant m\)</span> and each <span class="math inline">\(k \geqslant 1\)</span>. For identification, we need <span class="math inline">\(\sum_{t=1}^m S_t = 0\)</span> and <span class="math inline">\(\mathrm{E}(\epsilon_t)=0\)</span>.</p>
<p>Our goal is to estimate and extract <span class="math inline">\(M_t\)</span> and <span class="math inline">\(S_t\)</span> with the hope that the residual or noise component <span class="math inline">\(\epsilon_t\)</span> will turn out to be a stationary time series (<a href="#sec-movavg" class="quarto-xref"><span>Section 3.2</span></a>–<a href="#sec-regressionTime" class="quarto-xref"><span>Section 3.5</span></a>). Alternatively, Box–Jenkins models use difference operators repeatedly to the series <span class="math inline">\(Y_t\)</span> until a stationary time series is obtained (see <a href="#sec-differencing" class="quarto-xref"><span>Section 3.7</span></a> on differencing).</p>
<p>The seasonal component is said to have <em>constant seasonal variation</em> if the scaling factors satisfy <span class="math inline">\(\lambda_{k} = 1\)</span> for all <span class="math inline">\(k\)</span>. In other words, <span class="math inline">\(S_{t+m} = S_{t}\)</span> for all <span class="math inline">\(t\)</span>. The constant variation is an assumption of most modeling techniques we will be using in this course. Unfortunately, many real seasonal time series do not have this constancy property and it is necessary to first perform a <em>variance-stabilizing transformation</em> to modify the original time series into one with constant variation. To some extent, this is a matter of trial and error, where we work from ‘weaker’ transformations to ‘stronger’ transformations as needed. Typically, power transformations are used <span class="math inline">\(Y_{t} \rightarrow Y^{\lambda}_{t}\)</span>, where <span class="math inline">\(0 &lt; \lambda &lt; 1\)</span> or, log or even log log transformations, e.g., <span class="math inline">\(Y_{t} \rightarrow \log Y_{t}\)</span>.</p>
<p>The log transformation of <span class="math inline">\(Y_t\)</span> is convenient when we assume not an additive model as <a href="#eq-trseas" class="quarto-xref">Equation&nbsp;<span>3.1</span></a> is, but a multiplicative model as <span id="eq-trseasmult"><span class="math display">\[
Y_t = M_t \cdot S_t \cdot \epsilon_t.
\tag{3.2}\]</span></span> When applying variance-stabilizing log transformation to <a href="#eq-trseasmult" class="quarto-xref">Equation&nbsp;<span>3.2</span></a>, we get an additive result: <span id="eq-trseasmultlog"><span class="math display">\[
\log Y_t = \log M_t + \log S_t + \log \epsilon_t,
\tag{3.3}\]</span></span> which is now similar to <a href="#eq-trseas" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>. We will refer to <a href="#eq-trseas" class="quarto-xref">Equation&nbsp;<span>3.1</span></a> as <em>additive seasonality</em>, and to <a href="#eq-trseasmult" class="quarto-xref">Equation&nbsp;<span>3.2</span></a> as <em>multiplicative seasonality</em>. Only a few methods can deal with the multiplicative case <a href="#eq-trseasmult" class="quarto-xref">Equation&nbsp;<span>3.2</span></a> directly; most methods we consider in this course will require us to apply a transformation as in <a href="#eq-trseasmultlog" class="quarto-xref">Equation&nbsp;<span>3.3</span></a>.</p>
<p>In the following sections, we consider methods for the estimation and elimination of <span class="math inline">\(M_t\)</span> (for non-seasonal data, when <span class="math inline">\(S_t = 0\)</span> in the additive case <a href="#eq-trseas" class="quarto-xref">Equation&nbsp;<span>3.1</span></a> or <span class="math inline">\(S_t = 1\)</span> in the multiplicative case <a href="#eq-trseasmult" class="quarto-xref">Equation&nbsp;<span>3.2</span></a>) and of both <span class="math inline">\(M_t\)</span> and <span class="math inline">\(S_t\)</span> (for seasonal data).</p>
</section><section id="sec-movavg" class="level2" data-number="3.2"><h2 data-number="3.2" class="anchored" data-anchor-id="sec-movavg">
<span class="header-section-number">3.2</span> Finite moving average smoothing</h2>
<p>The non-seasonal model with a trend: <span class="math display">\[
Y_t = M_t + \epsilon_t,
\]</span> where <span class="math inline">\(\mathrm{E}(\epsilon_t)=0\)</span> and <span class="math inline">\(t=1,\dots,n\)</span>.</p>
<p>Let <span class="math inline">\(q\)</span> be a nonnegative integer (<span class="math inline">\(q \in \mathbb{N}^{+}\)</span>) and consider the <em>two-sided moving average</em> of the series <span class="math inline">\(Y_t\)</span>: <span id="eq-movav"><span class="math display">\[
\begin{split}
W_t &amp;= \frac{1}{2q+1}\sum_{j=-q}^q Y_{t-j}\\
&amp;= \frac{1}{2q+1}\sum_{j=-q}^q M_{t-j} + \frac{1}{2q+1}\sum_{j=-q}^q \epsilon_{t-j} \\
&amp;\approx M_t,
\end{split}
\tag{3.4}\]</span></span> where <span class="math inline">\(w = 2q+1\)</span> is the size of the moving window. Note that the above approximation is correct if the average value of <span class="math inline">\(\epsilon_{t}\)</span> within each window is close to 0 (important for selecting <span class="math inline">\(q\)</span>).</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Shampoo plots
</div>
</div>
<div class="callout-body-container callout-body">
<p><a href="#fig-shampoo" class="quarto-xref">Figure&nbsp;<span>3.1</span></a> shows a time series plot of monthly shampoo sales. While the data are monthly, the seasonal component is not visible:</p>
<ul>
<li>no strong periodicity in the time series plot;</li>
<li>the ACF at seasonal lag (1 year) is not significant.</li>
</ul>
<p>Therefore, we apply <a href="#eq-movav" class="quarto-xref">Equation&nbsp;<span>3.4</span></a> treating the shampoo time series as non-seasonal data.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Get the data from the package fma</span></span>
<span><span class="va">shampoo</span> <span class="op">&lt;-</span> <span class="fu">fma</span><span class="fu">::</span><span class="va"><a href="https://pkg.robjhyndman.com/fma/reference/shampoo.html">shampoo</a></span></span>
<span><span class="va">shampoo</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
#&gt; 1 266 146 183 119 180 168 232 224 193 123 336 186
#&gt; 2 194 150 210 273 191 287 226 304 290 422 264 342
#&gt; 3 340 440 316 439 401 437 576 408 682 475 581 647</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pshampoo</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">shampoo</span>, col <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Sales"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">shampoo</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">pshampoo</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-shampoo" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-shampoo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-shampoo-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shampoo-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.1: Monthly shampoo sales over three years and a corresponding sample ACF.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<p>There are multiple ways to calculate moving averages in R, and formulas for <span class="math inline">\(W_t\)</span> may vary. If using someone’s else functions, remember to read the help files or source code to find out the exact formula in place of <a href="#eq-movav" class="quarto-xref">Equation&nbsp;<span>3.4</span></a>. Below are some examples.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The package <code>forecast</code> is now retired in favor of the package <code>fable</code>.</p>
</div>
</div>
<p>For example, <code><a href="https://pkg.robjhyndman.com/forecast/reference/ma.html">forecast::ma()</a></code> has the default option <code>centre = TRUE</code>, and the <code>order</code> argument represents the window size. Odd <code>order</code> and <code>centre = TRUE</code> correspond exactly to our definitions in <a href="#eq-movav" class="quarto-xref">Equation&nbsp;<span>3.4</span></a>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ma.html">ma</a></span><span class="op">(</span><span class="va">shampoo</span>, order <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
#&gt; 1  NA  NA 179 159 177 185 200 188 222 213 206 198
#&gt; 2 215 203 204 222 238 256 260 306 301 324 332 362
#&gt; 3 341 376 387 407 434 452 501 516 544 559  NA  NA</code></pre>
</div>
</div>
<p>For example, <code><a href="https://rdrr.io/pkg/pracma/man/movavg.html">pracma::movavg()</a></code> averages the last <code>n</code> data points:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">pracma</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pracma/man/movavg.html">movavg</a></span><span class="op">(</span><span class="va">shampoo</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  [1] 266 206 198 179 179 159 177 185 200 188 222 213 206 198 215 203 204 222 238
#&gt; [20] 256 260 306 301 324 332 362 341 376 387 407 434 452 501 516 544 559</code></pre>
</div>
</div>
<p>The base-R function <code><a href="https://rdrr.io/r/stats/filter.html">stats::filter()</a></code> can also be used. Its odd window size and <code>sides = 2</code> correspond to our definitions in <a href="#eq-movav" class="quarto-xref">Equation&nbsp;<span>3.4</span></a>:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">window_size</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">shampoo</span>, filter <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">window_size</span>, <span class="va">window_size</span><span class="op">)</span>, sides <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
#&gt; 1  NA  NA 179 159 177 185 200 188 222 213 206 198
#&gt; 2 215 203 204 222 238 256 260 306 301 324 332 362
#&gt; 3 341 376 387 407 434 452 501 516 544 559  NA  NA</code></pre>
</div>
</div>
<p>The <code>sides = 1</code> in <code><a href="https://rdrr.io/r/stats/filter.html">stats::filter()</a></code> corresponds to the <code><a href="https://rdrr.io/pkg/pracma/man/movavg.html">pracma::movavg()</a></code> results above:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">shampoo</span>, filter <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">window_size</span>, <span class="va">window_size</span><span class="op">)</span>, sides <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec
#&gt; 1  NA  NA  NA  NA 179 159 177 185 200 188 222 213
#&gt; 2 206 198 215 203 204 222 238 256 260 306 301 324
#&gt; 3 332 362 341 376 387 407 434 452 501 516 544 559</code></pre>
</div>
</div>
<p>See <a href="#fig-shampoo-movavg" class="quarto-xref">Figure&nbsp;<span>3.2</span></a> and <a href="#fig-shampoo-movavg2" class="quarto-xref">Figure&nbsp;<span>3.3</span></a> for the effects of the window size.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Shampoo moving average smoothing
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">q</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">Wt</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/ma.html">ma</a></span><span class="op">(</span><span class="va">shampoo</span>, order <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span>    <span class="va">pshampoo</span> <span class="op">+</span> </span>
<span>        <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Wt</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu">ggtitle</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"q = "</span>, <span class="va">q</span>, <span class="st">" (window = "</span>, <span class="va">w</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">wrap_plots</span><span class="op">(</span><span class="va">ps</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-shampoo-movavg" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-shampoo-movavg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-shampoo-movavg-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shampoo-movavg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.2: Shampoo sales over three years smoothed with <em>centered</em> moving average filters, where the window size is <span class="math inline">\(w = 2q+1\)</span>.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">5</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">q</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">w</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">q</span> <span class="op">+</span> <span class="fl">1</span></span>
<span>    <span class="va">Wt</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">shampoo</span>, filter <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">w</span>, <span class="va">w</span><span class="op">)</span>, sides <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>    <span class="va">pshampoo</span> <span class="op">+</span> </span>
<span>        <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Wt</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>        <span class="fu">ggtitle</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"q = "</span>, <span class="va">q</span>, <span class="st">" (window = "</span>, <span class="va">w</span>, <span class="st">")"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">wrap_plots</span><span class="op">(</span><span class="va">ps</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-shampoo-movavg2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-shampoo-movavg2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-shampoo-movavg2-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shampoo-movavg2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.3: Shampoo sales over three years smoothed with <em>non-centered</em> moving average filters, where the window size is <span class="math inline">\(w = 2q+1\)</span>.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<section id="sec-movavgSeas" class="level3" data-number="3.2.1"><h3 data-number="3.2.1" class="anchored" data-anchor-id="sec-movavgSeas">
<span class="header-section-number">3.2.1</span> Moving average smoothing for seasonal data</h3>
<p>Come back to the trend-seasonal model <a href="#eq-trseas" class="quarto-xref">Equation&nbsp;<span>3.1</span></a>: <span class="math display">\[
Y_t = M_t + S_t + \epsilon_t.
\]</span></p>
<p>We apply the following steps for estimating seasonality and trend:</p>
<ol type="1">
<li>Apply a moving average filter specially chosen to eliminate the seasonal component and dampen the noise – get <span class="math inline">\(\hat{M}_t\)</span>. Remember that the sum of <span class="math inline">\(S_t\)</span> within each period is 0. Hence, to smooth out the seasonal component (and noise) and get an estimate of just <span class="math inline">\(M_t\)</span>, we will use a moving window <span class="math inline">\(w\)</span> sized as the seasonal period <span class="math inline">\(m\)</span> (more generally, <span class="math inline">\(w = km\)</span>, where <span class="math inline">\(k\in \mathbb{N}^{+}\)</span>, if a greater smoothness is desired). It will often lead to the even window size <span class="math inline">\(w\)</span>. For even <span class="math inline">\(w\)</span>, <a href="#eq-movav" class="quarto-xref">Equation&nbsp;<span>3.4</span></a> is modified as follows (we now use <span class="math inline">\(km + 1\)</span> elements so the window is still centered, but the elements on the ends receive half the weight): <span id="eq-movavEven"><span class="math display">\[
\hat{M}_t = \frac{0.5Y_{t-km/2} + Y_{t-km/2 + 1} +\dots+Y_{t+km/2-1} + 0.5Y_{t+km/2}}{km}.
\tag{3.5}\]</span></span>
</li>
<li>Use <span class="math inline">\(Y_t - \hat{M}_t\)</span> to estimate the seasonal component – get <span class="math inline">\(\hat{S}_t\)</span>. If needed, correct the estimates, to sum up to 0 in each period. Let <span class="math inline">\(\hat{S}^*_t\)</span> be the corrected values.</li>
<li>Use deseasonalized data <span class="math inline">\(Y_t - \hat{S}^*_t\)</span> to re-estimate the trend. Let <span class="math inline">\(\hat{M}^*_t\)</span> be the corrected trend estimate.</li>
<li>The estimated random noise is then: <span class="math inline">\(\hat{\epsilon}_t = Y_t - \hat{M}^*_t - \hat{S}^*_t\)</span>.</li>
</ol>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For the multiplicative case, replace subtractions with <em>divisions</em> and let the <em>product</em> of <span class="math inline">\(\hat{S}^*_t\)</span> be 1 within each seasonal period.</p>
</div>
</div>
<p>The above algorithm is implemented in <code><a href="https://rdrr.io/r/stats/decompose.html">stats::decompose()</a></code>, but its main disadvantage is in the centered moving average filter used to estimate <span class="math inline">\(M_t\)</span> that does not produce smoothed values for the most recent observations. We can elaborate this algorithm, first, by using different estimators for <span class="math inline">\(M_t\)</span>; second, by also replacing estimators for <span class="math inline">\(S_t\)</span> (e.g., see the next section).</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Secchi depth automatic (simple moving average-based) decomposition
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider monthly data of Secchi disk depth measured at station CB1.1 in Chesapeake Bay (<a href="#fig-Secchi" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>), with the decomposition in <a href="#fig-SecchiDecompose" class="quarto-xref">Figure&nbsp;<span>3.5</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">secchi_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html">read.csv</a></span><span class="op">(</span><span class="st">"data/Secchi_CB1.1.csv"</span>, header <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">Secchi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span><span class="va">secchi_data</span><span class="op">$</span><span class="va">Value</span>,</span>
<span>             start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">secchi_data</span><span class="op">$</span><span class="va">Year</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">secchi_data</span><span class="op">$</span><span class="va">Month</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">pSecchi</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">Secchi</span>, col <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Secchi depth (m)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">Secchi</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">pSecchi</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-Secchi" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-Secchi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-Secchi-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-Secchi-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.4: Monthly average Secchi disk depth at station CB1.1 and its ACF.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/decompose.html">decompose</a></span><span class="op">(</span><span class="va">Secchi</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-SecchiDecompose" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-SecchiDecompose-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-SecchiDecompose-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SecchiDecompose-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.5: Trend-seasonal decomposition of monthly average Secchi disk depth at station CB1.1.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Secchi depth manual simple moving average smoothing
</div>
</div>
<div class="callout-body-container callout-body">
<p>To replicate the behavior of the function <code><a href="https://rdrr.io/r/stats/decompose.html">stats::decompose()</a></code> or tune the outputs, use the following code. For example, <a href="#fig-SecchiDecompose" class="quarto-xref">Figure&nbsp;<span>3.5</span></a> shows a wiggly trend that we might want to smooth more, using a bigger window, such as 24 months instead of 12 months.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Yt</span> <span class="op">&lt;-</span> <span class="va">Secchi</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Initial trend estimate</span></span>
<span><span class="va">window_size</span> <span class="op">=</span> <span class="fl">24</span></span>
<span><span class="va">Mt</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Yt</span>, </span>
<span>                    filter <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">window_size</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">window_size</span>, <span class="va">window_size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                 <span class="fl">2</span><span class="op">*</span><span class="va">window_size</span><span class="op">)</span>, </span>
<span>                    sides <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 2. Estimate of the seasonality, corrected to sum up to 0</span></span>
<span><span class="va">St</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Yt</span> <span class="op">-</span> <span class="va">Mt</span>, <span class="va">month</span>, <span class="va">mean</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">St</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;       1       2       3       4       5       6       7       8       9      10 
#&gt; -0.0225  0.0869 -0.2469 -0.2791 -0.0748 -0.0379  0.1256  0.1831  0.1234  0.1150 
#&gt;      11      12 
#&gt;  0.0368 -0.0164</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">St</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -0.00673</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">St_star</span> <span class="op">&lt;-</span> <span class="va">St</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">St</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">St_star</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] -4.16e-17</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 3. Refined trend estimate</span></span>
<span><span class="va">Mt_star</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span><span class="op">(</span><span class="va">Yt</span> <span class="op">-</span> <span class="va">St_star</span><span class="op">[</span><span class="va">month</span><span class="op">]</span>, </span>
<span>                    filter <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">window_size</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="va">window_size</span>, <span class="va">window_size</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>                                 <span class="fl">2</span><span class="op">*</span><span class="va">window_size</span><span class="op">)</span>, </span>
<span>                    sides <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 4. Noise</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="va">Yt</span> <span class="op">-</span> <span class="va">Mt_star</span> <span class="op">-</span> <span class="va">St_star</span><span class="op">[</span><span class="va">month</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Convert back to ts format for plotting</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">Secchi</span><span class="op">)</span>, frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>See <a href="#fig-SecchiDeseasMA" class="quarto-xref">Figure&nbsp;<span>3.6</span></a> for the results.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Trend estimate: Mt_star"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span> <span class="op">+</span> <span class="va">St_star</span><span class="op">[</span><span class="va">month</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Final trend-cycle: Mt_star + St_star"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Residuals: et"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-SecchiDeseasMA" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-SecchiDeseasMA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-SecchiDeseasMA-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SecchiDeseasMA-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.6: Detrending using simple moving average and deseasonalizing the Secchi depth data.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="sec-lowess" class="level2" data-number="3.3"><h2 data-number="3.3" class="anchored" data-anchor-id="sec-lowess">
<span class="header-section-number">3.3</span> Lowess smoothing</h2>
<p>One of the alternatives for estimating trends <span class="math inline">\(M_t\)</span> is <em>locally weighted regression</em> (shortened as ‘lowess’ or ‘loess’) <span class="citation" data-cites="Cleveland:1979">(<a href="references.html#ref-Cleveland:1979" role="doc-biblioref">Cleveland 1979</a>)</span>. We can apply lowess as a regression of <span class="math inline">\(Y_t\)</span> on time, for example, using the algorithm outlined by <span class="citation" data-cites="Berk:2016">Berk (<a href="references.html#ref-Berk:2016" role="doc-biblioref">2016</a>)</span>:</p>
<ol type="1">
<li>Choose the smoothing parameter such as bandwidth, <span class="math inline">\(f\)</span>, which is a proportion between 0 and 1.</li>
<li>Choose a point <span class="math inline">\(t_0\)</span> and its <span class="math inline">\(w = f n\)</span> nearest points on the time axis.</li>
<li>For these <span class="math inline">\(w\)</span> nearest neighbor points, compute a weighted least squares regression line for <span class="math inline">\(Y_t\)</span> on <span class="math inline">\(t\)</span>. The coefficients <span class="math inline">\(\boldsymbol{\beta}\)</span> of such regression are estimated by minimizing the residual sum of squares <span class="math display">\[
\text{RSS}^*(\boldsymbol{\beta}) = (\boldsymbol{Y}^* - \boldsymbol{X}^* \boldsymbol{\beta})^{\top} \boldsymbol{W}^* (\boldsymbol{Y}^* - \boldsymbol{X}^* \boldsymbol{\beta}),
\]</span> where the asterisk indicates that only the observations in the window are included. The regressor matrix <span class="math inline">\(\boldsymbol{X}^*\)</span> can contain polynomial terms of time, <span class="math inline">\(t\)</span>. The <span class="math inline">\(\boldsymbol{W}^*\)</span> is a diagonal matrix conforming to <span class="math inline">\(\boldsymbol{X}^*\)</span>, with diagonal elements being a function of distance from <span class="math inline">\(t_0\)</span> (observations closer to <span class="math inline">\(t_0\)</span> receive higher weights).</li>
<li>Calculate the fitted value <span class="math inline">\(\tilde{Y}_t\)</span> for that single <span class="math inline">\(t_0\)</span>.</li>
<li>Repeat Steps 2–4 for each <span class="math inline">\(t_0 = 1,\dots,n\)</span>.</li>
</ol>
<p>By selecting large bandwidth <span class="math inline">\(f\)</span> in the lowess algorithm, we can obtain greater smoothing (see <a href="#fig-lowess" class="quarto-xref">Figure&nbsp;<span>3.7</span></a>).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="va">WWWusage</span><span class="op">)</span></span>
<span><span class="va">ps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span>, <span class="fl">0.75</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">w</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">WWWusage</span>, colour <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span>  <span class="op">+</span> </span>
<span>        <span class="fu">ggtitle</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"span = "</span>, <span class="va">w</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu">geom_smooth</span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span>, span <span class="op">=</span> <span class="va">w</span>, se <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu">wrap_plots</span><span class="op">(</span><span class="va">ps</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-lowess" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-lowess-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-lowess-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-lowess-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.7: A lowess illustration, adapted from <span class="citation" data-cites="Berk:2016">Berk (<a href="references.html#ref-Berk:2016" role="doc-biblioref">2016</a>)</span>.
</figcaption></figure>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The function <code><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">ggplot2::geom_smooth()</a></code> has the default setting <code>se = TRUE</code> that produces a confidence interval around the smooth. In time series applications, autocorrelated residuals may lead to underestimated standard errors and incorrect (typically, too narrow) confidence intervals. Hence, we set <code>se = FALSE</code>. For testing the significance of the identified trends, see lectures on trend testing (detection).</p>
</div>
</div>
<section id="lowess-smoothing-for-seasonal-data" class="level3" data-number="3.3.1"><h3 data-number="3.3.1" class="anchored" data-anchor-id="lowess-smoothing-for-seasonal-data">
<span class="header-section-number">3.3.1</span> Lowess smoothing for seasonal data</h3>
<p>Now use the Secchi time series (<a href="#fig-Secchi" class="quarto-xref">Figure&nbsp;<span>3.4</span></a>) and implement the procedure of detrending and deseasonalizing from <a href="#sec-movavgSeas" class="quarto-xref"><span>Section 3.2.1</span></a>, but replace the simple moving average estimates of <span class="math inline">\(M_t\)</span> with lowess estimates.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Secchi depth lowess-based decomposition
</div>
</div>
<div class="callout-body-container callout-body">
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Yt</span> <span class="op">&lt;-</span> <span class="va">Secchi</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 1. Initial trend estimate</span></span>
<span><span class="va">Mt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/loess.html">loess</a></span><span class="op">(</span><span class="va">Yt</span> <span class="op">~</span> <span class="va">t</span>, span <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span><span class="op">$</span><span class="va">fitted</span></span>
<span></span>
<span><span class="co"># 2. Estimate of the seasonality, corrected to sum up to 0</span></span>
<span><span class="va">St</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html">tapply</a></span><span class="op">(</span><span class="va">Yt</span> <span class="op">-</span> <span class="va">Mt</span>, <span class="va">month</span>, <span class="va">mean</span><span class="op">)</span></span>
<span><span class="va">St</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;       1       2       3       4       5       6       7       8       9      10 
#&gt; -0.0359  0.0457 -0.2483 -0.2683 -0.0716 -0.0129  0.1411  0.2024  0.1276  0.1108 
#&gt;      11      12 
#&gt;  0.0391 -0.0165</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">St</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 0.0131</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">St_star</span> <span class="op">&lt;-</span> <span class="va">St</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">St</span><span class="op">)</span><span class="op">/</span><span class="fl">12</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">St_star</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 3.47e-18</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># 3. Refined trend estimate</span></span>
<span><span class="va">Mt_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/loess.html">loess</a></span><span class="op">(</span><span class="op">(</span><span class="va">Yt</span> <span class="op">-</span> <span class="va">St_star</span><span class="op">[</span><span class="va">month</span><span class="op">]</span><span class="op">)</span> <span class="op">~</span> <span class="va">t</span>, span <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span><span class="op">$</span><span class="va">fitted</span></span>
<span></span>
<span><span class="co"># 4. Noise</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="va">Yt</span> <span class="op">-</span> <span class="va">Mt_star</span> <span class="op">-</span> <span class="va">St_star</span><span class="op">[</span><span class="va">month</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Convert back to ts format for plotting</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/ts.html">ts</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span>, start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/start.html">start</a></span><span class="op">(</span><span class="va">Secchi</span><span class="op">)</span>, frequency <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>See <a href="#fig-SecchiDeseas" class="quarto-xref">Figure&nbsp;<span>3.8</span></a> for the results.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Trend estimate: Mt_star"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span> <span class="op">+</span> <span class="va">St_star</span><span class="op">[</span><span class="va">month</span><span class="op">]</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Final trend-cycle: Mt_star + St_star"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Residuals: et"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-SecchiDeseas" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-SecchiDeseas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-SecchiDeseas-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SecchiDeseas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.8: Detrending using lowess and deseasonalizing the Secchi depth data.
</figcaption></figure>
</div>
</div>
</div>
<p>In <a href="#fig-SecchiDeseas2" class="quarto-xref">Figure&nbsp;<span>3.9</span></a>, we use the decomposition function <code><a href="https://rdrr.io/r/stats/stl.html">stl()</a></code> forced to have approximately the same values as we used in the steps above and as shown in <a href="#fig-SecchiDeseas" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>. Hence, <a href="#fig-SecchiDeseas" class="quarto-xref">Figure&nbsp;<span>3.8</span></a> and <a href="#fig-SecchiDeseas2" class="quarto-xref">Figure&nbsp;<span>3.9</span></a> are similar. However, the function <code><a href="https://rdrr.io/r/stats/stl.html">stl()</a></code> is more flexible – it also automatically smooths the seasonal component (across Januaries, across Februaries, etc.) – and can provide finer estimates (see <a href="#fig-SecchiDeseas3" class="quarto-xref">Figure&nbsp;<span>3.10</span></a>).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Span we used above (the fraction)</span></span>
<span><span class="va">span</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span></span>
<span><span class="co"># Window size in number of lags (observations)</span></span>
<span><span class="va">w</span> <span class="op">&lt;-</span> <span class="va">span</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Secchi</span><span class="op">)</span><span class="op">/</span><span class="fl">2</span> </span>
<span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/stl.html">stl</a></span><span class="op">(</span><span class="va">Yt</span>, s.window <span class="op">=</span> <span class="st">"periodic"</span>, t.window <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span><span class="va">Mt_star</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">$</span><span class="va">time.series</span><span class="op">[</span>,<span class="st">"trend"</span><span class="op">]</span></span>
<span><span class="va">St_star</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">$</span><span class="va">time.series</span><span class="op">[</span>,<span class="st">"seasonal"</span><span class="op">]</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">$</span><span class="va">time.series</span><span class="op">[</span>,<span class="st">"remainder"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Trend estimate: Mt_star"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span> <span class="op">+</span> <span class="va">St_star</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Final trend-cycle: Mt_star + St_star"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Residuals: et"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-SecchiDeseas2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-SecchiDeseas2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-SecchiDeseas2-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SecchiDeseas2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.9: Detrending and deseasonalizing the Secchi depth data using lowess within the function <code><a href="https://rdrr.io/r/stats/stl.html">stl()</a></code> forced to behave similarly to <a href="#fig-SecchiDeseas" class="quarto-xref">Figure&nbsp;<span>3.8</span></a>.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">D</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/stl.html">stl</a></span><span class="op">(</span><span class="va">Yt</span>, s.window <span class="op">=</span> <span class="fl">24</span>, s.degree <span class="op">=</span> <span class="fl">1</span>, t.window <span class="op">=</span> <span class="va">w</span><span class="op">)</span></span>
<span><span class="va">Mt_star</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">$</span><span class="va">time.series</span><span class="op">[</span>,<span class="st">"trend"</span><span class="op">]</span></span>
<span><span class="va">St_star</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">$</span><span class="va">time.series</span><span class="op">[</span>,<span class="st">"seasonal"</span><span class="op">]</span></span>
<span><span class="va">et</span> <span class="op">&lt;-</span> <span class="va">D</span><span class="op">$</span><span class="va">time.series</span><span class="op">[</span>,<span class="st">"remainder"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Trend estimate: Mt_star"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pSecchi</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">Mt_star</span> <span class="op">+</span> <span class="va">St_star</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Final trend-cycle: Mt_star + St_star"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Residuals: et"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">et</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-SecchiDeseas3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-SecchiDeseas3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-SecchiDeseas3-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-SecchiDeseas3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.10: Detrending and deseasonalizing the Secchi depth data using lowess within the function <code><a href="https://rdrr.io/r/stats/stl.html">stl()</a></code> with default settings.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="exponential-smoothing" class="level2" data-number="3.4"><h2 data-number="3.4" class="anchored" data-anchor-id="exponential-smoothing">
<span class="header-section-number">3.4</span> Exponential smoothing</h2>
<p>Exponential smoothing (ES) is a successful forecasting technique. It turns out that ES can be modified to be used effectively for time series with</p>
<ul>
<li>slowly drifting trend (double exponential smoothing);</li>
<li>trends (Holt’s method);</li>
<li>seasonal patterns;</li>
<li>combination of trend and seasonality (Holt–Winters method).</li>
</ul>
<p>ES is easy to adjust for past errors and easy to prepare follow-on forecasts. ES is ideal for situations where many forecasts must be prepared. Several different functional forms of ES are used depending on the presence of trend or cyclical variations.</p>
<p>In short, an ES is an averaging technique that uses unequal weights while the weights applied to past observations decline in an exponential manner.</p>
<p><strong>Single exponential smoothing</strong> calculates the smoothed series as a damping coefficient <span class="math inline">\(\alpha\)</span> (<span class="math inline">\(\alpha \in [0, 1]\)</span>) times the actual series plus <span class="math inline">\(1 - \alpha\)</span> times the lagged value of the smoothed series. For the model <span class="math display">\[
Y_{t} = M_t + \epsilon_{t},
\]</span> the updating equation is <span class="math display">\[
\begin{split}
\hat{M}_1 &amp;= Y_1\\
\hat{M}_t &amp;= \alpha Y_t + (1 - \alpha) \hat{M}_{t - 1}
\end{split}
\]</span> and the forecast is <span class="math display">\[
\hat{Y}_{t+1} = \hat{M}_t.
\]</span></p>
<p>An exponential smoothing over an already smoothed time series is called <em>double exponential smoothing</em>. In some cases, it might be necessary to extend it even to a <em>triple exponential smoothing</em>.</p>
<p><strong>Holt’s linear exponential smoothing</strong> Suppose that the series <span class="math inline">\(Y_t\)</span> is non-seasonal but displays a trend. Now we need to estimate both the current mean (a.k.a. <em>level</em>) and the current trend.</p>
<p>The updating equations express ideas similar to those for exponential smoothing. However, now we have two smoothing parameters, <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(\beta\)</span> (<span class="math inline">\(\alpha \in [0, 1]\)</span>; <span class="math inline">\(\beta \in [0, 1]\)</span>).</p>
<p>The updating equations are <span class="math display">\[
a_{t} = \alpha Y_{t} + \left( 1- \alpha \right) \left( a_{t - 1} + b_{t - 1} \right)
\]</span> for the mean and <span class="math display">\[
b_{t} = \beta \left( a_{t} - a_{t-1} \right) + \left( 1 - \beta \right) b_{t-1}
\]</span> for the trend.</p>
<p>Then the forecasting for <span class="math inline">\(k\)</span> steps into the future is <span class="math display">\[
\hat{Y}_{t+k} = a_{t} + kb_{t}.
\]</span></p>
<p>Usually, the initial (starting) values are <span class="math display">\[
\begin{split}
a_{1} &amp; = Y_{2}, \\
b_{1} &amp; = Y_{2} - Y_{1}.
\end{split}
\]</span></p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Shampoo exponential smoothing
</div>
</div>
<div class="callout-body-container callout-body">
<p>See an example in <a href="#fig-shampoo-ses" class="quarto-xref">Figure&nbsp;<span>3.11</span></a>.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"0.3"</span> <span class="op">=</span> <span class="fl">4</span>, <span class="st">"0.7"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">shampoo</span>, alpha <span class="op">=</span> <span class="fl">0.3</span>, beta <span class="op">=</span> <span class="cn">FALSE</span>, gamma <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">shampoo</span>, alpha <span class="op">=</span> <span class="fl">0.7</span>, beta <span class="op">=</span> <span class="cn">FALSE</span>, gamma <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pshampoo</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"0.3"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"0.7"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Simple exponential smoothing"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"\u03b1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">)</span></span>
<span><span class="va">clrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"(0.3, 0.3)"</span> <span class="op">=</span> <span class="fl">4</span>, <span class="st">"(0.7, 0.7)"</span> <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">shampoo</span>, alpha <span class="op">=</span> <span class="fl">0.3</span>, beta <span class="op">=</span> <span class="fl">0.3</span>, gamma <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">shampoo</span>, alpha <span class="op">=</span> <span class="fl">0.7</span>, beta <span class="op">=</span> <span class="fl">0.7</span>, gamma <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pshampoo</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">m1</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"(0.3, 0.3)"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html">fitted</a></span><span class="op">(</span><span class="va">m2</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>, <span class="fu">aes</span><span class="op">(</span>col <span class="op">=</span> <span class="st">"(0.7, 0.7)"</span><span class="op">)</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Holt's method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">labs</span><span class="op">(</span>color <span class="op">=</span> <span class="st">"(\u03b1, \u03b2)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">scale_color_manual</span><span class="op">(</span>values <span class="op">=</span> <span class="va">clrs</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-shampoo-ses" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-shampoo-ses-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-shampoo-ses-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shampoo-ses-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.11: Shampoo sales over three years smoothed with different exponential smoothing filters.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<section id="exponential-smoothing-for-seasonal-data" class="level3" data-number="3.4.1"><h3 data-number="3.4.1" class="anchored" data-anchor-id="exponential-smoothing-for-seasonal-data">
<span class="header-section-number">3.4.1</span> Exponential smoothing for seasonal data</h3>
<p><strong>Multiplicative Holt–Winters procedure</strong></p>
<p>Now in addition to the Holt parameters, suppose that the series exhibits multiplicative seasonality and let <span class="math inline">\(S_{t}\)</span> be the multiplicative seasonal factor at the time <span class="math inline">\(t\)</span>.</p>
<p>Suppose also that there are <span class="math inline">\(m\)</span> observations in one period (in a year). For example, <span class="math inline">\(m = 4\)</span> for quarterly data, and <span class="math inline">\(m = 12\)</span> for monthly data.</p>
<p>In some time series, seasonal variation is so strong it obscures any trends or other cycles, which are important for our understanding of the observed process. Holt–Winters smoothing method can remove seasonality and makes long-term fluctuations in the series stand out more clearly.</p>
<p>A simple way of detecting a trend in seasonal data is to take averages over a certain period. If these averages change with time we can say that there is evidence of a trend in the series.</p>
<p>We now use three smoothing parameters: <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span>, and <span class="math inline">\(\gamma\)</span> (<span class="math inline">\(\alpha \in [0, 1]\)</span>; <span class="math inline">\(\beta \in [0, 1]\)</span>; <span class="math inline">\(\gamma \in [0, 1]\)</span>).</p>
<p>The updating equations for the level (<span class="math inline">\(a_t\)</span>), local trend (<span class="math inline">\(b_t\)</span>), and seasonal factor (<span class="math inline">\(S_t\)</span>) are: <span class="math display">\[
\begin{split}
a_{t} &amp; = \alpha Y_{t} / S_{t - m} + (1 - \alpha) ( a_{t - 1} + b_{t - 1}), \\
b_{t} &amp; = \beta (a_{t} - a_{t - 1}) + (1 - \beta) b_{t - 1}, \\
S_{t} &amp; = \gamma Y_{t} / a_{t} + (1 - \gamma) S_{t - m}.
\end{split}
\]</span></p>
<p>Then the forecasting for <span class="math inline">\(k\)</span> steps into the future is <span class="math display">\[
\hat{Y}_{t+k} = (a_{t} + kb_{t}) S_{t+k-m},
\]</span> where <span class="math inline">\(k = 1, 2, \dots, m\)</span>.</p>
<p>To obtain starting values, one may use an average over the first few periods (years) of the data.</p>
<p>The smoothing parameters <span class="math inline">\(\alpha\)</span>, <span class="math inline">\(\beta\)</span> and <span class="math inline">\(\gamma\)</span> are estimated by minimizing the sum of the squared one-step prediction errors.</p>
<p><strong>Additive Holt–Winters procedure</strong></p>
<p>The updating equations are <span class="math display">\[
\begin{split}
a_{t} &amp; = \alpha (Y_{t} - S_{t - m}) + (1 - \alpha) (a_{t - 1} + b_{t - 1}), \\
b_{t} &amp; = \beta (a_{t} - a_{t - 1}) + (1 - \beta) b_{t - 1} \\
S_{t} &amp; = \gamma (Y_{t} - a_{t}) + (1 - \gamma) S_{t - m}.
\end{split}
\]</span></p>
<p>Then the forecasting for <span class="math inline">\(k\)</span> steps into the future is <span class="math display">\[
\hat{Y}_{t+k} = a_{t} + kb_{t} + S_{t + k - m},
\]</span> where <span class="math inline">\(k = 1, 2, \dots, m\)</span>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Airline passengers non-seasonal and seasonal exponential smoothing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Monthly totals of international airline passengers, 1949–1960 (see <a href="#fig-airpassangers" class="quarto-xref">Figure&nbsp;<span>3.12</span></a>). This is a classical example in time series analysis. Note that the seasonal variability increases with the increasing mean, hence, we deal with the multiplicative seasonality.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">pAirPassengers</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">AirPassengers</span>, col <span class="op">=</span> <span class="st">"grey50"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ylab</span><span class="op">(</span><span class="st">"Airline passengers (thousand)"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">pAirPassengers</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangers" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangers-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangers-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.12: Monthly <code>AirPassengers</code> data and a corresponding sample ACF.
</figcaption></figure>
</div>
</div>
</div>
<p>Comparison of various exponential smoothing techniques for the <code>AirPassengers</code> data:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">AirPassengers</span>, beta <span class="op">=</span> <span class="cn">FALSE</span>, gamma <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">m1</span><span class="op">$</span><span class="va">SSE</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 162511</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m1</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">m1</span><span class="op">$</span><span class="va">beta</span>, <span class="va">m1</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 1 0 0</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">AirPassengers</span>, gamma <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">m2</span><span class="op">$</span><span class="va">SSE</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 163634</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m2</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">m2</span><span class="op">$</span><span class="va">beta</span>, <span class="va">m2</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;   alpha    beta         
#&gt; 1.00000 0.00322 0.00000</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span></span>
<span><span class="va">m3</span><span class="op">$</span><span class="va">SSE</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 21860</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m3</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">m3</span><span class="op">$</span><span class="va">beta</span>, <span class="va">m3</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  alpha   beta  gamma 
#&gt; 0.2480 0.0345 1.0000</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">m4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/HoltWinters.html">HoltWinters</a></span><span class="op">(</span><span class="va">AirPassengers</span>, seasonal <span class="op">=</span> <span class="st">"multiplicative"</span><span class="op">)</span></span>
<span><span class="va">m4</span><span class="op">$</span><span class="va">SSE</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; [1] 16571</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb51"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">m4</span><span class="op">$</span><span class="va">alpha</span>, <span class="va">m4</span><span class="op">$</span><span class="va">beta</span>, <span class="va">m4</span><span class="op">$</span><span class="va">gamma</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;  alpha   beta  gamma 
#&gt; 0.2756 0.0327 0.8707</code></pre>
</div>
</div>
<p>The last multiplicative model is the best one, based on the sum of squared errors (SSE) in the training set (see <a href="#fig-airpassangersHW" class="quarto-xref">Figure&nbsp;<span>3.13</span></a>). For a more thorough comparison, consider using out-of-sample data in cross-validation.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb53"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">k</span> <span class="op">=</span> <span class="fl">12</span></span>
<span><span class="va">fm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m1</span>, n.ahead <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span><span class="va">fm2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m2</span>, n.ahead <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span><span class="va">fm3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m3</span>, n.ahead <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span><span class="va">fm4</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">m4</span>, n.ahead <span class="op">=</span> <span class="va">k</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">m1</span><span class="op">$</span><span class="va">fitted</span><span class="op">[</span>,<span class="st">"xhat"</span><span class="op">]</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">autolayer</span><span class="op">(</span><span class="va">fm1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Exponential smoothing"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">m2</span><span class="op">$</span><span class="va">fitted</span><span class="op">[</span>,<span class="st">"xhat"</span><span class="op">]</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">autolayer</span><span class="op">(</span><span class="va">fm2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Holt's method"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">m3</span><span class="op">$</span><span class="va">fitted</span><span class="op">[</span>,<span class="st">"xhat"</span><span class="op">]</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">autolayer</span><span class="op">(</span><span class="va">fm3</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Additive Holt-Winters"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span>data <span class="op">=</span> <span class="va">m4</span><span class="op">$</span><span class="va">fitted</span><span class="op">[</span>,<span class="st">"xhat"</span><span class="op">]</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">autolayer</span><span class="op">(</span><span class="va">fm4</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Multiplicative Holt-Winters"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">theme</span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"none"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangersHW" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangersHW-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangersHW-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangersHW-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.13: Plots of the observed, fitted, and predicted <code>AirPassengers</code> data, using various smoothing procedures.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="sec-regressionTime" class="level2" data-number="3.5"><h2 data-number="3.5" class="anchored" data-anchor-id="sec-regressionTime">
<span class="header-section-number">3.5</span> Polynomial regression on time</h2>
<p>This is a very intuitive procedure for fitting parametric trend functions to time series:</p>
<ul>
<li>Make a parametric model assumption about <span class="math inline">\(M_t\)</span> as a function of time <span class="math inline">\(t\)</span>, for example, quadratic trend: <span class="math display">\[
M_t = \beta_0 + \beta_1 t + \beta_2 t^2
\]</span>
</li>
<li>Fit the model using the usual regression estimators (least squares or maximum likelihood)</li>
</ul>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A nonstationary time series with a trend represented by a parametric function is a typical example of a <em>trend-stationary time series</em> or a time series with a <em>deterministic trend</em>. It is easy to make such a time series stationary by modeling and extracting the trend.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Airline passengers non-seasonal polynomial smoothing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Continue using the <code>AirPassengers</code> data and fit linear and quadratic trends.</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">t2</span> <span class="op">&lt;-</span> <span class="va">t</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="va">tm1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">AirPassengers</span> <span class="op">~</span> <span class="va">t</span><span class="op">)</span></span>
<span><span class="va">tm2.1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">AirPassengers</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="va">t2</span><span class="op">)</span></span>
<span><span class="va">tm2.2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">AirPassengers</span> <span class="op">~</span> <span class="va">t</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/AsIs.html">I</a></span><span class="op">(</span><span class="va">t</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">tm2.3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">AirPassengers</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">t</span>, degree <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>After estimating the trend coefficients with OLS, visualize the results (<a href="#fig-airpassangersRegTrend" class="quarto-xref">Figure&nbsp;<span>3.14</span></a>).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">tm1</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Linear trend"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">tm2.3</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Quadratic trend"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangersRegTrend" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangersRegTrend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangersRegTrend-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangersRegTrend-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.14: Plots of the <code>AirPassengers</code> data with estimated parametric linear and quadratic trends.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The models <code>tm2.1</code> and <code>tm2.2</code> are equivalent. Model <code>tm2.1</code> uses a pre-calculated quadratic transformation, while model <code>tm2.2</code> applies the transformation on the fly within the R formula call, using the <code><a href="https://rdrr.io/r/base/AsIs.html">I()</a></code> syntax (without the <code><a href="https://rdrr.io/r/base/AsIs.html">I()</a></code> wrapper, the output of <code>tm2.2</code> would be the same as of <code>tm1</code>, not <code>tm2.1</code>). However, both models <code>tm2.1</code> and <code>tm2.2</code> can easily violate the assumption of independence of predictors in linear regression, especially when values of the time index <span class="math inline">\(t\)</span> are large. It applies to our example because the sequence <span class="math inline">\(t\)</span> of decimal years goes from 1949 to 1960.917, and <span class="math inline">\(\widehat{\mathrm{cor}}(t, t^2) =\)</span> 1. Therefore, model <code>tm2.3</code> is preferred, because it is evaluated on orthogonal polynomials (centering and normalization are applied to <span class="math inline">\(t\)</span> and <span class="math inline">\(t^2\)</span>).</p>
</div>
</div>
<section id="seasonal-regression-with-dummy-variables" class="level3" data-number="3.5.1"><h3 data-number="3.5.1" class="anchored" data-anchor-id="seasonal-regression-with-dummy-variables">
<span class="header-section-number">3.5.1</span> Seasonal regression with dummy variables</h3>
<p>To each time <span class="math inline">\(t\)</span> and each season <span class="math inline">\(k\)</span> we will assign an indicator that ‘turns on’ if and only if <span class="math inline">\(t\)</span> falls into that season. In principle, a seasonal period of any positive integer length <span class="math inline">\(m \geqslant 2\)</span> is possible, however, in most cases, the length of the seasonal cycle is one year and so the seasonal period of the time series depends on the number of observations per year. Some common periods are <span class="math inline">\(m = 12\)</span> (monthly data) and <span class="math inline">\(m = 4\)</span> (quarterly data). For each <span class="math inline">\(k = 1, \dots, m\)</span>, we define the indicator <span class="math display">\[
X_{k,t} = \left\{
\begin{array}{cl}
1, &amp; \mbox{if} ~ t ~ \text{corresponds to season} ~ k, \\
0, &amp; \mbox{if} ~ t ~ \text{does not correspond to season} ~ k. \\
\end{array}
\right.
\]</span></p>
<p>Note that for each <span class="math inline">\(t\)</span> we have <span class="math inline">\(X_{1,t} + X_{2,t} + \dots + X_{m,t} = 1\)</span> since each <span class="math inline">\(t\)</span> corresponds to exactly one season. Thus, given any <span class="math inline">\(m - 1\)</span> of the variables, the remaining variable is known and thus redundant. Because of this linear dependence, we must drop one of the indicator variables (seasons) from the model. It does not matter which season is dropped although sometimes there are choices that are simpler from the point of view of constructing or labeling the design matrix. Thus the general form of a seasonal model looks like <span class="math display">\[
\begin{split}
f (Y_{t}) &amp;= M_{t} + \beta_{2} X_{2,t} + \beta_{3} X_{3,t} + \dots + \beta_{m} X_{m,t} + \epsilon_{t} \\
&amp;= M_{t} + \sum_{i=2}^{m}\beta_{i} X_{i,t} + \epsilon_{t},
\end{split}
\]</span> where <span class="math inline">\(M_{t}\)</span> is a trend term which may also include some <span class="math inline">\(\beta\)</span> parameters and explanatory variables. The function <span class="math inline">\(f\)</span> represents the appropriate variance-stabilizing transformations as needed. (Here the 1st season has been dropped from the model.)</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Airline passengers polynomial smoothing with dummy variables for the seasons
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider adding the dummy variables to model seasonality together with the quadratic trend in the <code>AirPassengers</code> time series. We noticed multiplicative seasonality in this time series before, therefore we apply a logarithmic transformation to the original data to transform the multiplicative seasonality into additive. That is, we need to estimate the model <span class="math display">\[
\ln(Y_{t}) = \alpha_0 + \alpha_1 t + \alpha_2 t^2 + \sum_{i=2}^{12}\beta_{i} X_{i,t} + \epsilon_{t},
\]</span> where <span class="math inline">\(X_{i,t}\)</span> are the dummy variables for the months. (Here the first month has been dropped from the model, the same as in R the first factor level is dropped.)</p>
<p>If we were doing the regression analysis by hand, we would create a design matrix with its few top rows looking like this:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;          t      t2 X2 X3 X4 X5 X6 X7 X8 X9 X10 X11 X12
#&gt;  [1,] 1949 3798601  0  0  0  0  0  0  0  0   0   0   0
#&gt;  [2,] 1949 3798926  1  0  0  0  0  0  0  0   0   0   0
#&gt;  [3,] 1949 3799251  0  1  0  0  0  0  0  0   0   0   0
#&gt;  [4,] 1949 3799576  0  0  1  0  0  0  0  0   0   0   0
#&gt;  [5,] 1949 3799900  0  0  0  1  0  0  0  0   0   0   0
#&gt;  [6,] 1949 3800225  0  0  0  0  1  0  0  0   0   0   0
#&gt;  [7,] 1950 3800550  0  0  0  0  0  1  0  0   0   0   0
#&gt;  [8,] 1950 3800875  0  0  0  0  0  0  1  0   0   0   0
#&gt;  [9,] 1950 3801200  0  0  0  0  0  0  0  1   0   0   0
#&gt; [10,] 1950 3801525  0  0  0  0  0  0  0  0   1   0   0
#&gt; [11,] 1950 3801850  0  0  0  0  0  0  0  0   0   1   0
#&gt; [12,] 1950 3802175  0  0  0  0  0  0  0  0   0   0   1
#&gt; [13,] 1950 3802500  0  0  0  0  0  0  0  0   0   0   0</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The way the months are represented above as separate columns of 0s and 1s is called <em>one-hot encoding</em> in the field of machine learning.</p>
</div>
</div>
<p>In R, it is enough to have <em>one</em> variable representing the seasons. This categorical variable should be saved as a <code>factor</code>. Then we apply the OLS method to find the model coefficients (see results in <a href="#fig-airpassangersRegTrendSeas" class="quarto-xref">Figure&nbsp;<span>3.15</span></a>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">t</span>, degree <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">Month</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Call:
#&gt; lm(formula = log(AirPassengers) ~ poly(t, degree = 2) + Month)
#&gt; 
#&gt; Residuals:
#&gt;      Min       1Q   Median       3Q      Max 
#&gt; -0.12748 -0.03709  0.00418  0.03197  0.11529 
#&gt; 
#&gt; Coefficients:
#&gt;                      Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)           5.45716    0.01392  391.91  &lt; 2e-16 ***
#&gt; poly(t, degree = 2)1  5.02251    0.04837  103.84  &lt; 2e-16 ***
#&gt; poly(t, degree = 2)2 -0.39837    0.04820   -8.26  1.4e-13 ***
#&gt; Month2               -0.02227    0.01968   -1.13  0.25984    
#&gt; Month3                0.10779    0.01968    5.48  2.2e-07 ***
#&gt; Month4                0.07639    0.01968    3.88  0.00016 ***
#&gt; Month5                0.07393    0.01968    3.76  0.00026 ***
#&gt; Month6                0.19603    0.01968    9.96  &lt; 2e-16 ***
#&gt; Month7                0.29997    0.01969   15.24  &lt; 2e-16 ***
#&gt; Month8                0.29072    0.01969   14.77  &lt; 2e-16 ***
#&gt; Month9                0.14617    0.01969    7.42  1.3e-11 ***
#&gt; Month10               0.00814    0.01970    0.41  0.67991    
#&gt; Month11              -0.13540    0.01970   -6.87  2.4e-10 ***
#&gt; Month12              -0.02132    0.01971   -1.08  0.28129    
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Residual standard error: 0.0482 on 130 degrees of freedom
#&gt; Multiple R-squared:  0.989,  Adjusted R-squared:  0.988 
#&gt; F-statistic:  913 on 13 and 130 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangersRegTrendSeas" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangersRegTrendSeas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangersRegTrendSeas-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangersRegTrendSeas-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.15: The <code>AirPassengers</code> data, with estimated parametric quadratic trend and seasonality (modeled using <em>dummy variables</em>), and ACF of the residuals. Since the model was fitted on the log scale, the trend-cycle estimates need to be exponentiated to match the original scale of the data.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section><section id="seasonal-regression-with-fourier-series" class="level3" data-number="3.5.2"><h3 data-number="3.5.2" class="anchored" data-anchor-id="seasonal-regression-with-fourier-series">
<span class="header-section-number">3.5.2</span> Seasonal regression with Fourier series</h3>
<p>It is a spoiler for the future lecture on spectral analysis of time series, but seasonal regression modeling would not be complete without introducing the trigonometric Fourier series.</p>
<p>We can fit a linear regression model using several pairs of trigonometric functions as predictors. For example, for monthly observations <span class="math display">\[
\begin{split}
cos_{k} (i) &amp;= \cos (2 \pi ki / 12), \\
sin_{k} (i) &amp;= \sin (2 \pi ki / 12),
\end{split}
\]</span> where <span class="math inline">\(i\)</span> is the month within the year, and the trigonometric function has <span class="math inline">\(k\)</span> cycles per year.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Airline passengers polynomial smoothing with Fourier series for the seasons
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now let us apply the method of sinusoids to the <code>AirPassengers</code> time series. We have one prominent and, possibly, one less prominent peak per year. Hence, we can test the model with <span class="math inline">\(k = 1\)</span> and <span class="math inline">\(k = 2\)</span>. We will construct the following trigonometric predictors: <span class="math display">\[
\begin{split}
cos_{1,t} &amp;= \cos(2 \pi \text{month}_t/12),\\
sin_{1,t} &amp;= \sin(2 \pi \text{month}_t/12),\\
cos_{2,t} &amp;= \cos(4 \pi \text{month}_t/12),\\
sin_{2,t} &amp;= \sin(4 \pi \text{month}_t/12)
\end{split}
\]</span> to use in the model <span class="math display">\[
\ln(Y_{t}) = \alpha_0 + \alpha_1 t + \alpha_2 t^2 + \beta_{1}cos_{1,t} + \beta_{2}sin_{1,t} + \beta_{3}cos_{2,t} + \beta_{4}sin_{2,t} + \epsilon_{t}.
\]</span></p>
<p>Calculate the predictors and estimate the model in R (see results in <a href="#fig-airpassangersRegTrendFourier" class="quarto-xref">Figure&nbsp;<span>3.16</span></a>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb60"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cos1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">month</span> <span class="op">/</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">sin1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">month</span> <span class="op">/</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">cos2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">cos</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">month</span> <span class="op">/</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">sin2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Trig.html">sin</a></span><span class="op">(</span><span class="fl">4</span> <span class="op">*</span> <span class="va">pi</span> <span class="op">*</span> <span class="va">month</span> <span class="op">/</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/poly.html">poly</a></span><span class="op">(</span><span class="va">t</span>, degree <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> <span class="va">cos1</span> <span class="op">+</span> <span class="va">sin1</span> <span class="op">+</span> <span class="va">cos2</span> <span class="op">+</span> <span class="va">sin2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Call:
#&gt; lm(formula = log(AirPassengers) ~ poly(t, degree = 2) + cos1 + 
#&gt;     sin1 + cos2 + sin2)
#&gt; 
#&gt; Residuals:
#&gt;      Min       1Q   Median       3Q      Max 
#&gt; -0.20078 -0.03539 -0.00056  0.04065  0.13771 
#&gt; 
#&gt; Coefficients:
#&gt;                      Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)           5.54218    0.00493 1123.46  &lt; 2e-16 ***
#&gt; poly(t, degree = 2)1  5.02920    0.05936   84.72  &lt; 2e-16 ***
#&gt; poly(t, degree = 2)2 -0.39819    0.05920   -6.73  4.3e-10 ***
#&gt; cos1                 -0.14152    0.00698  -20.28  &lt; 2e-16 ***
#&gt; sin1                 -0.04923    0.00699   -7.04  8.3e-11 ***
#&gt; cos2                 -0.02276    0.00698   -3.26   0.0014 ** 
#&gt; sin2                  0.07874    0.00698   11.28  &lt; 2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Residual standard error: 0.0592 on 137 degrees of freedom
#&gt; Multiple R-squared:  0.983,  Adjusted R-squared:  0.982 
#&gt; F-statistic: 1.3e+03 on 6 and 137 DF,  p-value: &lt;2e-16</code></pre>
</div>
</div>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb62"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangersRegTrendFourier" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangersRegTrendFourier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangersRegTrendFourier-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangersRegTrendFourier-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.16: The <code>AirPassengers</code> data, with estimated parametric quadratic trend and seasonality (modeled using <em>trigonometric functions</em>), and ACF of the residuals. Since the model was fitted on the log scale, the trend-cycle estimates need to be exponentiated to match the original scale of the data.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section></section><section id="sec-GAM" class="level2" data-number="3.6"><h2 data-number="3.6" class="anchored" data-anchor-id="sec-GAM">
<span class="header-section-number">3.6</span> Generalized additive models (GAMs)</h2>
<p>An alternative way of modeling nonlinearities in trends, seasonality, and other patterns is by replacing the original variables with those individually transformed using smooth nonparametric functions, such as in a <em>generalized additive model</em> <span class="citation" data-cites="Wood:2006book">(GAM, <a href="references.html#ref-Wood:2006book" role="doc-biblioref">Wood 2006</a>)</span>. The model is called ‘generalized’ because the distribution of the response variable <span class="math inline">\(Y_t\)</span> is not just normal but can be from a family of exponential distributions, such as Poisson, binomial, and gamma. A smooth monotonic function <span class="math inline">\(g(\cdot)\)</span> called the ‘link function’ is applied to transform the response variable. However, our interest currently is in the additive nature of these models.</p>
<p>Instead of fitting a global nonlinear function like in a polynomial regression (<a href="#sec-regressionTime" class="quarto-xref"><span>Section 3.5</span></a>) or fitting simpler local polynomials directly like in lowess smoothing (<a href="#sec-lowess" class="quarto-xref"><span>Section 3.3</span></a>), we can construct a basis from basic splines (B-splines). B-splines are simple functions, which vanish outside the intervals defined by time points called the ‘knots.’ These splines are defined recursively, from the lowest to higher orders, starting from a simple indicator function for the intervals between the knots <span class="citation" data-cites="Hastie:etal:2009 Wood:2006book">(see Appendix to Chapter 5 in <a href="references.html#ref-Hastie:etal:2009" role="doc-biblioref">Hastie et al. 2009</a>; or Chapter 4.1 in <a href="references.html#ref-Wood:2006book" role="doc-biblioref">Wood 2006</a> for the recursive formulas)</span>. Here we show the results of the recursive computations, for times <span class="math inline">\(t = 1, \dots,\)</span> 100 and knots 1, 10, 20, 50 spaced unequally for illustration purposes (uniformly-spaced knots give us cardinal B-splines). <a href="#fig-BS1" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> shows a basis formed by B-splines of degree one, and <a href="#fig-BS2" class="quarto-xref">Figure&nbsp;<span>3.18</span></a> shows splines of degree two.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-BS1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-BS1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-BS1-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BS1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.17: B-splines of degree one. The vertical dashed lines denote locations of the knots.
</figcaption></figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div id="fig-BS2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-BS2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-BS2-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BS2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.18: B-splines of degree two. The vertical dashed lines denote locations of the knots.
</figcaption></figure>
</div>
</div>
</div>
<p>In the next step, the basis is used in regression, for example, to model the expected value <span class="math inline">\(\mu_t\)</span> of the <code>WWWusage</code> data introduced in <a href="#sec-lowess" class="quarto-xref"><span>Section 3.3</span></a>: <span id="eq-GAM"><span class="math display">\[
g(\mu_t) = \alpha_0 + f(t),
\tag{3.6}\]</span></span> where <span class="math inline">\(\alpha_0\)</span> is the intercept, and <span class="math inline">\(f(t)\)</span> represents the added effects of the <span class="math inline">\(M\)</span> basis functions <span class="math inline">\(B_m(t)\)</span> (hence the word ‘additive’ in GAM): <span class="math display">\[
f(t) = \sum_{m = 1}^M \beta_m B_m(t).
\]</span> Here we may assume that the response <code>WWWusage</code> is normally distributed. The link function <span class="math inline">\(g(\cdot)\)</span> for normal distribution is identity (no transformation to the original data), hence we can omit it and rewrite <a href="#eq-GAM" class="quarto-xref">Equation&nbsp;<span>3.6</span></a> for our data as follows: <span class="math display">\[
\mu_t = \alpha_0 + f(t).
\]</span> We are not interested in the individual regression coefficients <span class="math inline">\(\beta_m\)</span> (regression parameters) we estimated, hence the function <span class="math inline">\(f(t)\)</span> is <em>nonparametric</em> even though many parameters have been estimated to obtain <span class="math inline">\(f(t)\)</span>, similar to lowess smoothing.</p>
<p>The model in <a href="#eq-GAM" class="quarto-xref">Equation&nbsp;<span>3.6</span></a> can handle deviations from normality and can accommodate nonlinearity and nonmonotonicity of individual relationships, however, the model does not address the potential issue of remaining dependencies in the errors <span class="citation" data-cites="Kohn:etal:2000">(e.g., see <a href="references.html#ref-Kohn:etal:2000" role="doc-biblioref">Kohn et al. 2000</a>)</span>. We skip the topic of selecting an appropriate distribution, testing statistical significance of estimated patterns, or using the reported confidence intervals for inference until later in the course when we are familiar with various tests for autocorrelation and trends (e.g., see <a href="l07_trendtest.html" class="quarto-xref"><span>Chapter 7</span></a> on trend tests and <a href="l09_tsreg2.html#sec-GAMLSS" class="quarto-xref"><span>Section 9.5</span></a> using additional covariates, specifying structure of the regression errors, and extending GAM to several parameters of an exponential distribution beyond just the mean).</p>
<p><a href="#fig-BSreg" class="quarto-xref">Figure&nbsp;<span>3.19</span></a> shows the results of fitting the model in <a href="#eq-GAM" class="quarto-xref">Equation&nbsp;<span>3.6</span></a> to the bases shown in <a href="#fig-BS1" class="quarto-xref">Figure&nbsp;<span>3.17</span></a> and <a href="#fig-BS2" class="quarto-xref">Figure&nbsp;<span>3.18</span></a>. The results are not so bad given the knots were set without considering the data.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-BSreg" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-BSreg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-BSreg-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-BSreg-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.19: Results of regressing <code>WWWusage</code> on the linear, quadratic, and cubic B-spline bases. The fit in each case is suboptimal because the knots were set arbitrarily.
</figcaption></figure>
</div>
</div>
</div>
<p>The number and locations of the knots are important tuning parameters for achieving the desired smoothness. Fortunately, there exist cross-validation procedures and penalization techniques that allow us to set these parameters rather automatically. When a penalty is applied to the basis coefficients, B-splines are called P-splines.</p>
<p>The R packages <code>mgcv</code> and <code>gamlss</code> provide several types of smoothing splines. In this lecture, we demonstrate the package <code>mgcv</code> but we will use the package <code>gamlss</code> in <a href="l09_tsreg2.html#sec-GAMLSS" class="quarto-xref"><span>Section 9.5</span></a>.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: GAM of WWWusage
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider fitting the GAM specified in <a href="#eq-GAM" class="quarto-xref">Equation&nbsp;<span>3.6</span></a> to the <code>WWWusage</code> time series. Here we use B-splines again (see <code><a href="https://rdrr.io/pkg/mgcv/man/smooth.terms.html">?mgcv::smooth.terms</a></code> and <code><a href="https://rdrr.io/pkg/mgcv/man/smooth.construct.bs.smooth.spec.html">?mgcv::b.spline</a></code> for different options), but allow the parameters to be estimated each time using cross-validation (see <code><a href="https://rdrr.io/pkg/mgcv/man/gam.html">?mgcv::gam</a></code> for more details).</p>
<p>In the code below, we estimate the model four times, with different spline orders <code>m[1]</code> (quadratic or cubic) and basis dimensions <code>k</code> (<code>k</code> controls the overall smoothness as it sets the upper limit on the degrees of freedom associated with a smooth, see <code><a href="https://rdrr.io/pkg/mgcv/man/choose.k.html">?mgcv::choose.k</a></code>). The models can be compared using the Akaike information criterion (AIC).</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mgcv</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">WWWusage</span><span class="op">)</span></span>
<span><span class="va">mwww_q1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">WWWusage</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">t</span>, bs <span class="op">=</span> <span class="st">"bs"</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mwww_c1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">WWWusage</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">t</span>, bs <span class="op">=</span> <span class="st">"bs"</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mwww_c2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">WWWusage</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">t</span>, bs <span class="op">=</span> <span class="st">"bs"</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mwww_c3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">WWWusage</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">t</span>, bs <span class="op">=</span> <span class="st">"bs"</span>, m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">2</span><span class="op">)</span>, k <span class="op">=</span> <span class="fl">15</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/AIC.html">AIC</a></span><span class="op">(</span><span class="va">mwww_q1</span>, <span class="va">mwww_c1</span>, <span class="va">mwww_c2</span>, <span class="va">mwww_c3</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt;            df AIC
#&gt; mwww_q1 10.92 701
#&gt; mwww_c1 10.91 726
#&gt; mwww_c2  5.97 887
#&gt; mwww_c3 15.20 641</code></pre>
</div>
</div>
<p>From the results above and <a href="#fig-WWWusageGAM" class="quarto-xref">Figure&nbsp;<span>3.20</span></a>, we may conclude that when the smoothing parameters are allowed to be selected automatically, restricting the degrees of freedom leads to more dramatic changes than switching the order of splines.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb65"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">p0</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">mwww_q1</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Quadratic splines, automatic k"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="va">p0</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">mwww_c1</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Cubic splines, automatic k"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">p0</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">mwww_c2</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Cubic splines, k = 5"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="va">p0</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">mwww_c3</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"Cubic splines, k = 15"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-WWWusageGAM" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-WWWusageGAM-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-WWWusageGAM-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-WWWusageGAM-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.20: Results of regressing <code>WWWusage</code> on time, using the smoothing splines.
</figcaption></figure>
</div>
</div>
</div>
<p>Summary of the last model using cubic smoothing splines:</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb66"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">mwww_c3</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>#&gt; 
#&gt; Family: gaussian 
#&gt; Link function: identity 
#&gt; 
#&gt; Formula:
#&gt; WWWusage ~ s(t, bs = "bs", m = c(3, 2), k = 15)
#&gt; 
#&gt; Parametric coefficients:
#&gt;             Estimate Std. Error t value Pr(&gt;|t|)    
#&gt; (Intercept)  137.080      0.552     248   &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; Approximate significance of smooth terms:
#&gt;       edf Ref.df   F p-value    
#&gt; s(t) 13.2   13.8 369  &lt;2e-16 ***
#&gt; ---
#&gt; Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
#&gt; 
#&gt; R-sq.(adj) =  0.981   Deviance explained = 98.3%
#&gt; GCV = 35.568  Scale est. = 30.519    n = 100</code></pre>
</div>
</div>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: GAM of the airline passengers time series
</div>
</div>
<div class="callout-body-container callout-body">
<p>Consider fitting a GAM to the airline passengers time series. Similar to our previous analyses, we need to apply logarithmic transformations to stabilize the variance and transform the multiplicative seasonality to additive, but now we have a few more options to choose from. We may continue assuming a lognormal distribution of the response with the identity link <span class="math inline">\(g(\mathrm{E}(Y_t)) = \mathrm{E}(Y_t)\)</span> <span id="eq-GAMlno"><span class="math display">\[
Y_t \sim LN(\mu_t, \sigma^2) \text{ or equivalently } \ln(Y_t) ~ N(\mu_t, \sigma^2)
\tag{3.7}\]</span></span> or use a normal distribution with the logarithmic link function <span class="math inline">\(g(\mathrm{E}(Y_t)) = \ln(\mathrm{E}(Y_t))\)</span>: <span id="eq-GAMno"><span class="math display">\[
Y_t \sim N(\mu_t, \sigma^2).
\tag{3.8}\]</span></span> The main difference between these options is how the errors are interpreted.</p>
<p>For the expected values, we will use a GAM with smoothing splines applied to the numeric time and month: <span class="math display">\[
g(\mu_t) = \alpha_0 + f_1(t) + f_2(Month_t).
\]</span> This model will capture a potentially non-monotonic trend and seasonality. We will use cyclical splines for <span class="math inline">\(f_2(\cdot)\)</span>. Cyclical splines have an additional penalty to ensure a smooth transition between the last and the first month of the annual cycle (from December to January).</p>
<p>Below we fit the model for both distribution families, lognormal with the identity link function (<a href="#eq-GAMlno" class="quarto-xref">Equation&nbsp;<span>3.7</span></a>) and normal with the logarithmic link (<a href="#eq-GAMno" class="quarto-xref">Equation&nbsp;<span>3.8</span></a>):</p>
<div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb68"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html">as.vector</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">time</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">month</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/time.html">cycle</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_lno</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">month</span>, bs <span class="op">=</span> <span class="st">"cp"</span><span class="op">)</span>, </span>
<span>         family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"identity"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">m_no</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/gam.html">gam</a></span><span class="op">(</span><span class="va">AirPassengers</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcv/man/s.html">s</a></span><span class="op">(</span><span class="va">month</span>, bs <span class="op">=</span> <span class="st">"cp"</span><span class="op">)</span>, </span>
<span>         family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html">gaussian</a></span><span class="op">(</span>link <span class="op">=</span> <span class="st">"log"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p><a href="#fig-airpassangersGAM" class="quarto-xref">Figure&nbsp;<span>3.21</span></a> shows the results of smoothing are quite similar. In both cases, we were not able to fully remove seasonality from the data, based on the residual autocorrelation at the seasonal lag of 12 months.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb69"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">m_lno</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"GAM smoothing using lognormal distribution"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m_lno</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals, using lognormal distribution"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="va">pAirPassengers</span> <span class="op">+</span> </span>
<span>    <span class="fu">geom_line</span><span class="op">(</span><span class="fu">aes</span><span class="op">(</span>y <span class="op">=</span> <span class="va">m_no</span><span class="op">$</span><span class="va">fitted.values</span><span class="op">)</span>, col <span class="op">=</span> <span class="fl">4</span>, lwd <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"GAM smoothing using normal distribution with log link"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">m_no</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">ggtitle</span><span class="op">(</span><span class="st">"ACF of residuals, using normal distribution with log link"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">xlab</span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangersGAM" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangersGAM-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangersGAM-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangersGAM-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.21: Plots of the <code>AirPassengers</code> data smoothed with GAMs and ACFs of the residuals.
</figcaption></figure>
</div>
</div>
</div>
<p>We might prefer using the formulation in <a href="#eq-GAMno" class="quarto-xref">Equation&nbsp;<span>3.8</span></a> since it captures the most recent peaks better (<a href="#fig-airpassangersGAM" class="quarto-xref">Figure&nbsp;<span>3.21</span></a> C) than the alternative (<a href="#fig-airpassangersGAM" class="quarto-xref">Figure&nbsp;<span>3.21</span></a> A), however, more rigorous numeric comparisons can be performed.</p>
<p>The fitted smooth functions can be visualized using <code>plot(m_no)</code> or using the <code>ggplot2</code>-type graphics as in <a href="#fig-airpassangersGAMterms" class="quarto-xref">Figure&nbsp;<span>3.22</span></a>. Note that the smooths are centered at 0 for the identifiability. This model used approximately 8.069 degrees of freedom to fit the trend, which is much more than the polynomial regression used. To fit the seasonality, the GAM used approximately 8.922 degrees of freedom, which is between the numbers for the regressions with Fourier series (4) and categorical months (11). Note that the quality of removing seasonality by GAM in this case is also between the regressions with Fourier series (strong autocorrelation at the seasonal lag remains, <a href="#fig-airpassangersRegTrendFourier" class="quarto-xref">Figure&nbsp;<span>3.16</span></a>) and categorical months (no significant autocorrelation at the seasonal lag, <a href="#fig-airpassangersRegTrendSeas" class="quarto-xref">Figure&nbsp;<span>3.15</span></a>).</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb70"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mfasiolo/mgcViz">mgcViz</a></span><span class="op">)</span></span>
<span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/mgcViz/man/getViz.html">getViz</a></span><span class="op">(</span><span class="va">m_no</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">b</span>, allTerms <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> </span>
<span>          <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_light</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      pages <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-airpassangersGAMterms" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-airpassangersGAMterms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-airpassangersGAMterms-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-airpassangersGAMterms-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.22: GAM smoothers. Solid curves are the function estimates, dashed curves are 2 standard errors above and below the estimate. The y-labels show the variable to which the smoothing splines were applied and the approximate degrees of freedom used for the smooth.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section><section id="sec-differencing" class="level2" data-number="3.7"><h2 data-number="3.7" class="anchored" data-anchor-id="sec-differencing">
<span class="header-section-number">3.7</span> Differencing</h2>
<p>A big subset of time series models (particularly, models dealing with random walk series) applies the differencing to eliminate trends.</p>
<p>Let <span class="math inline">\(\Delta\)</span> be the difference operator (<span class="math inline">\(\nabla\)</span> notation is also used sometimes), then the simple first-order differences are: <span class="math display">\[
\begin{split}
\Delta Y_t &amp;= Y_t - Y_{t-1} \\
&amp;=(1-B)Y_t,
\end{split}
\]</span> where <span class="math inline">\(B\)</span> is a backshift operator.</p>
<p>The <strong>backshift operator</strong> and difference operator are useful for a convenient representation of higher-order differences. We will often use backshift operators in future lectures: <span class="math display">\[
\begin{split}
B^0Y_{t} &amp;= Y_{t} \\
BY_{t} &amp;= Y_{t-1} \\
B^{2}Y_{t} &amp;= Y_{t-2} \\
&amp; \vdots \\
B^{k}Y_{t} &amp;= Y_{t-k}.
\end{split}
\]</span> The convenience is because the powers of the operators can be treated as powers of elements of usual polynomials, so we can make different operations for more complex cases.</p>
<p>For example, if we took second-order differences, <span class="math inline">\(\Delta^2Y_t = (1-B)^2Y_t\)</span>, to remove a trend and then used differences with the seasonal lag of 12 months to remove a strong seasonal component, what would be the final form of the transformed series? The transformed series, <span class="math inline">\(Y^*_t\)</span>, will be: <span class="math display">\[
\begin{split}
Y^*_t &amp; = (1-B)^2 (1 - B^{12})Y_t \\
&amp; = (1 - 2B + B^2) (1 - B^{12})Y_t \\
&amp; = (1 - 2B + B^2 - B^{12} + 2B^{13} - B^{14})Y_t \\
&amp; = Y_t - 2Y_{t-1} + Y_{t-2} - Y_{t-12} + 2Y_{t-13}-Y_{t-14},
\end{split}
\]</span> but we will often use just the top-row notations.</p>
<p>We will discuss formal tests to identify an appropriate order of differences in future lectures (unit-root tests), but for now use the <em>rule of thumb:</em> for time trends looking linear use 1st order differences (<span class="math inline">\(\Delta Y_t = Y_t - Y_{t-1}\)</span>), for parabolic shapes use differences of the 2nd order, etc. Apply the differencing of higher orders until the time series looks stationary (plot the transformed series and its ACF at each step). In practice, differences of order 3 or higher are rarely needed.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>A nonstationary time series that can be converted to stationary by taking differences is also sometimes called a <em>difference-stationary time series</em> or a time series with a <em>stochastic trend</em>. Very rarely, a time series may contain both deterministic and stochastic trends that need to be modeled or removed for further analysis.</p>
</div>
</div>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Shampoo detrending by differencing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remove the trend from the shampoo series by applying the differences.</p>
<p>Based on <a href="#fig-shampooDiff" class="quarto-xref">Figure&nbsp;<span>3.23</span></a>, differencing once is enough to remove the trend. The resulting detrended series is <span class="math display">\[
Y^*_t = \Delta Y_t = (1 - B)Y_t = Y_t - Y_{t-1}.
\]</span></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb71"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">pshampoo</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Yt"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">shampoo</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">shampoo</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Sales"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"D1"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">shampoo</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">shampoo</span>, differences <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Sales"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"D2"</span><span class="op">)</span></span>
<span><span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">shampoo</span>, differences <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-shampooDiff" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-shampooDiff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-shampooDiff-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-shampooDiff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.23: Time series plot of shampoo sales with an estimated ACF and the differenced series with their ACFs.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
<p>A deterministic linear trend can be also eliminated by differencing. For example, consider a time series <span class="math inline">\(X-t\)</span> with a deterministic linear trend: <span class="math display">\[
X_t = a + b t + Z_t,
\]</span> where <span class="math inline">\(Z_t \sim \mathrm{WN}(0,\sigma^2)\)</span>. The first-order differences of <span class="math inline">\(X_t\)</span> remove the linear trend: <span class="math display">\[
\begin{align}
(1 - B)X_t &amp;= X_t - X_{t-1} \\
&amp;= a + b t + Z_t - (a + b (t - 1) + Z_{t-1}) \\
&amp;= a + b t + Z_t - a - b t + b - Z_{t-1} \\
&amp;= b + Z_t + Z_{t-1}.
\end{align}
\]</span></p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Airline passengers detrending and deseasonalizing by differencing
</div>
</div>
<div class="callout-body-container callout-body">
<p>Remove trend and seasonality from the log-transformed <code>AirPassengers</code> series by applying the differences.</p>
<p>Based on <a href="#fig-AirPassengersDiff" class="quarto-xref">Figure&nbsp;<span>3.24</span></a>, differencing once with the non-seasonal and the seasonal lags is enough to remove the trend and strong seasonality. The final series (denoted as <code>D1D12</code>) is <span class="math display">\[
\begin{split}
D1D12_t &amp; = (1 - B)(1 - B^{12})\lg Y_t = (1 - B - B^{12} + B^{13})\lg Y_t\\
&amp; = \lg Y_t - \lg Y_{t-1} - \lg Y_{t-12} + \lg Y_{t-13}.
\end{split}
\]</span></p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb72"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">Yt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">AirPassengers</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Apply first-order (non-seasonal) differences</span></span>
<span><span class="va">D1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Additionally, apply first-order seasonal differences</span></span>
<span><span class="va">D1D12</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html">diff</a></span><span class="op">(</span><span class="va">D1</span>, lag <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"log10(Air passangers)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Yt"</span><span class="op">)</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">Yt</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Yt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">D1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"log10(Air passangers)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"(1-B)Yt"</span><span class="op">)</span></span>
<span><span class="va">p4</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">D1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"(1-B)Yt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="va">p5</span> <span class="op">&lt;-</span> <span class="fu">ggplot2</span><span class="fu">::</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">D1D12</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"log10(Air passangers)"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"(1-B)(1-B12)Yt"</span><span class="op">)</span></span>
<span><span class="va">p6</span> <span class="op">&lt;-</span> <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/autoplot.acf.html">ggAcf</a></span><span class="op">(</span><span class="va">D1D12</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"(1-B)(1-B12)Yt"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Lag (months)"</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p1</span> <span class="op">+</span> <span class="va">p2</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p3</span> <span class="op">+</span> <span class="va">p4</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">p5</span> <span class="op">+</span> <span class="va">p6</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">plot_annotation</span><span class="op">(</span>tag_levels <span class="op">=</span> <span class="st">'A'</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-AirPassengersDiff" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-AirPassengersDiff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-AirPassengersDiff-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-AirPassengersDiff-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.24: Time series plot of the airline passenger series with an estimated ACF and the detrended (differenced) series with their ACFs.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>
</section><section id="conclusion" class="level2" data-number="3.8"><h2 data-number="3.8" class="anchored" data-anchor-id="conclusion">
<span class="header-section-number">3.8</span> Conclusion</h2>
<p>We have implemented various methods for trend visualization, modeling, and trend removal. In each case, the method could be extended to also remove a strong seasonal signal. The choice of a method depends on many things, such as:</p>
<ul>
<li>The methods require different skill levels (and time commitment) for their implementation and can be categorized as automatic and non-automatic.</li>
<li>Some methods are very flexible when dealing with seasonality (e.g., Holt–Winters), while others are not.</li>
<li>The goal of smoothing and desired degree of smoothness in the output.</li>
<li>Some of the methods have a convenient way of getting forecasts (e.g., exponential smoothing and polynomial regression), while other methods are more suitable for interpolation (polynomial regression) and simple visualization (simple moving average), or just trend elimination (all of the considered methods are capable of eliminating trends, but differencing is the method that does nothing else but the elimination).</li>
</ul>
<p>Remember that forecasted values (point forecasts) are not valuable if their uncertainty is not quantified. To quantify the uncertainty, we provide prediction intervals that are based on the past behavior of residuals and careful residual diagnostics (such as described in the previous lectures).</p>
<p>The evaluation of the methods may involve splitting the time series into training and testing periods. Overall, this lecture focused on presenting the methods themselves, while <em>residual diagnostics</em> and <em>evaluation on a testing set</em> were omitted due to time constraints.</p>
<p>While the considered methods are among the most common, there are many more smoothing methods that can be applied to time series, including machine learning techniques.</p>
</section><section id="appendix" class="level2" data-number="3.9"><h2 data-number="3.9" class="anchored" data-anchor-id="appendix">
<span class="header-section-number">3.9</span> Appendix</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Example: Smoothing blocks
</div>
</div>
<div class="callout-body-container callout-body">
<p>A student was concerned about applying smoothing to data with a block-like structure. Without a real dataset on hand, below we simulate a series <span class="math inline">\(X_t\)</span> with the mentioned structure.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb73"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set number of blocks</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">10</span> </span>
<span></span>
<span><span class="co"># Let the values of blocks come from standard normal distribution,</span></span>
<span><span class="co"># and length of block be a random variable generated from Poisson distribution:</span></span>
<span><span class="va">Xt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details>
</div>
<p><a href="#fig-blocks" class="quarto-xref">Figure&nbsp;<span>3.25</span></a> shows an example of lowess applied to <span class="math inline">\(X_t\)</span> to get a smoothed series <span class="math inline">\(M_t\)</span>.</p>
<p>We see that lowess estimates <em>smooth</em> trends. If we assume that trends are not smooth, then some other techniques (e.g., piecewise linear estimation) should be used.</p>
<div class="cell">
<details class="code-fold"><summary>Code</summary><div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb74"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">Xt</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>t <span class="op">=</span> <span class="va">t</span>, Xt <span class="op">=</span> <span class="va">Xt</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">t</span>, y <span class="op">=</span> <span class="va">Xt</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>se <span class="op">=</span> <span class="cn">FALSE</span>, span <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</details><div class="cell-output-display">
<div id="fig-blocks" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure"><div aria-describedby="fig-blocks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="l03_smoothing_files/figure-html/fig-blocks-1.png" class="img-fluid figure-img" width="768">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-blocks-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3.25: Smoothing of the block-like data <span class="math inline">\(X_t\)</span>.
</figcaption></figure>
</div>
</div>
</div>
</div>
</div>


<div id="refs" class="references csl-bib-body hanging-indent" role="list" style="display: none">
<div id="ref-Berk:2016" class="csl-entry" role="listitem">
Berk RA (2016) <a href="https://doi.org/10.1007/978-3-319-44048-4">Statistical learning from a regression perspective</a>, 2nd edn. Springer, Switzerland
</div>
<div id="ref-Brockwell:Davis:2002" class="csl-entry" role="listitem">
Brockwell PJ, Davis RA (2002) Introduction to time series and forecasting, 2nd edn. Springer, New York, NY, USA
</div>
<div id="ref-Cleveland:1979" class="csl-entry" role="listitem">
Cleveland WS (1979) Robust locally weighted regression and smoothing scatterplots. Journal of the American Statistical Association 74:829–836. <a href="https://doi.org/10.1080/01621459.1979.10481038">https://doi.org/10.1080/01621459.1979.10481038</a>
</div>
<div id="ref-Hastie:etal:2009" class="csl-entry" role="listitem">
Hastie TJ, Tibshirani RJ, Friedman JH (2009) <a href="https://doi.org/10.1007/978-0-387-84858-7">The elements of statistical learning: Data mining, inference, and prediction</a>, 2nd edn. Springer, New York, NY, USA
</div>
<div id="ref-Kirchgassner:Wolters:2007" class="csl-entry" role="listitem">
Kirchgässner G, Wolters J (2007) <a href="https://doi.org/10.1007/978-3-540-73291-4">Introduction to modern time series analysis</a>. Springer-Verlag, Berlin, Germany
</div>
<div id="ref-Kohn:etal:2000" class="csl-entry" role="listitem">
Kohn R, Schimek MG, Smith M (2000) <a href="https://doi.org/10.1002/9781118150658.ch6">Spline and kernel regression for dependent data</a>. In: Schimek MG (ed) Smoothing and regression: Approaches, computation, and application. John Wiley &amp; Sons, Inc., New York, pp 135–158
</div>
<div id="ref-Wood:2006book" class="csl-entry" role="listitem">
Wood SN (2006) Generalized additive models: An introduction with r. Chapman; Hall/CRC, New York, NY, USA
</div>
</div>
</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./l02_tsintro.html" class="pagination-link" aria-label="Introduction to Time Series Analysis">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Introduction to Time Series Analysis</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./l04_arma.html" class="pagination-link" aria-label="Autoregressive Moving Average (ARMA) Models">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Autoregressive Moving Average (ARMA) Models</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/vlyubchich/tsar/edit/master/l03_smoothing.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/vlyubchich/tsar/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>